import { APIGatewayProxyResult, S3Event } from "aws-lambda";
import * as AWS from "@aws-sdk/client-rekognition";

const REGION = process.env.AWS_REGION;
const config = { region: REGION };
const client = new AWS.Rekognition(config);

type CustomStepFunctionEventT = {
  image: string;
};

const convertBase64ImageTo8Array = (img: string) => {
  const base64SignatureFormat = /data:image\/[a-z]{3,4};base64,/g;

  const convertedImgStr = img.replace(base64SignatureFormat, "");

  const image = Uint8Array.from(atob(convertedImgStr), (v) => v.charCodeAt(0));
  return image;
};

const validateUploadedImage = async (img: string) => {
  const config: AWS.DetectFacesCommandInput = {
    Image: { Bytes: convertBase64ImageTo8Array(img) },
  };

  const result = await client.detectFaces(config);

  if (!result.FaceDetails || result.FaceDetails.length !== 1) {
    throw new Error("No or multiple faces found");
  }

  const face: AWS.FaceDetail = result.FaceDetails[0];

  if (!face.Confidence || face.Confidence < 90) {
    throw new Error("Confidence failed");
  }

  return face;
};

const createResponse = (statusCode: number, body: unknown) => {
  let response: APIGatewayProxyResult = {
    statusCode: statusCode,
    headers: {
      "Content-Type": "application/json",
      "Access-Control-Allow-Origin": "*",
    },
    body: JSON.stringify({
      body,
    }),
  };
  return response;
};

export const lambdaHandler = async (
  event: CustomStepFunctionEventT
): Promise<any> => {
  try {
    console.log(event);

    /*   if (!event || !event.image) {
      throw new Error("no images provided");
    }
 */
    const img =
      "data:image/jpeg;base64,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";

    const face = await validateUploadedImage(img);
    return createResponse(200, {
      FaceDetails: face,
    });
  } catch (error) {
    console.log(error);
    return createResponse(400, (error as any).message);
  }
};
